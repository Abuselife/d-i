# Make cdrom bootable pre and post image creation

arch-cdrom-pre_image:
	$(MAKE) $(DEST)/floppy-boot-$(CDROM_INITRD).img FLOPPY_SIZE=8192
	mkdir -p $(TREE_DIR)/boot
	cp $(DEST)/floppy-boot-$(CDROM_INITRD).img $(TREE_DIR)/boot/boot.img
#	$(foreach NAME,$(KERNELNAME), \
#		gzip -9 < $(TEMP)/$(NAME) > $(TREE_DIR)/linux; )
#	cp  boot/ia64/elilo.conf $(TREE_DIR)/boot/elilo.conf
#	cp  cp /usr/lib/elilo/elilo.efi $(TREE_DIR)/boot/elilo.efi

arch-cdrom-post_image:

arch-cdrom-image:
	mkisofs -r -J -no-emul-boot -boot-load-size 1 -b boot/boot.img -o $(TEMP_IMAGE) $(TREE_DIR)


# Floppies

# Make floppy bootable, install kernel+initrd into tree_dir
arch-floppy-pre_image:
	mkdir -p $(TREE_DIR)/efi/boot/
	$(foreach NAME,$(KERNELNAME), \
             gzip -9 < $(TEMP)/$(NAME) > $(TREE_DIR)/linux)
	cp /usr/lib/elilo/elilo.efi $(TREE_DIR)/efi/boot/bootia64.efi
	cp boot/ia64/elilo.conf $(TREE_DIR)/efi/boot/elilo.conf

# Make floppy bootable, install syslinux
arch-floppy-post_image:

# Create a floppy image.
# 1. make a dos filesystem image
# 2. copy over the floppy_tree
arch-floppy-image:
	mkfs.msdos -i $(DOS_VOLUME_ID) -n $(DOS_VOLUME_LABEL) -C $(TEMP_IMAGE) $(FLOPPY_SIZE)
	# mkfs.msdos gets the mode wrong (bug filed)
	chmod 644 $(TEMP_IMAGE)
	mcopy -sQ -i$(TEMP_IMAGE) $(TREE_DIR)/* ::
