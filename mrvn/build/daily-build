#!/bin/sh -e

if [ ! -d pkg-lists ]; then
    echo "You must run this from the build directory"
    exit 1
fi

host=people.debian.org
basedir=public_html/d-i/images
dir=`date +%Y-%m-%d`

unset LANG LC_ALL LANGUAGE
cvs up

make clean
make mirror-update
fakeroot make -k

#make all_stats > dest/stats.txt
echo -n >dest/stats.txt
for i in diskusage*; do
  echo >>dest/stats.txt
  echo "$i" >>dest/stats.txt
  echo "==============================================" >>dest/stats.txt
  cat $i >>dest/stats.txt
  echo >>dest/stats.txt
done

# Keep Packages lists
cp -a tmp/mirror/dists dest/

ssh $host mkdir $basedir/$dir
ssh $host rm -f $basedir/daily
ssh $host ln -sf $dir $basedir/daily
scp -r tmp/vmlinuz dest/* $host:$basedir/$dir/

make clean
